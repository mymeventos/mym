<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel de Administración</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; margin: 0; padding: 2em; background-color: #f0f2f5; color: #333; }
        .container { max-width: 900px; margin: auto; background-color: #fff; padding: 2em; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1, h2, h3 { color: #2c3e50; }
        .form-section { background: #f9f9f9; padding: 1.5em; border-radius: 8px; margin-bottom: 2em; }
        .form-section h3 { margin-top: 0; }
        .form-group { margin-bottom: 1em; }
        label { display: block; margin-bottom: 5px; font-weight: bold; }
        input[type="text"], select, button { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        button { background-color: #3498db; color: white; border: none; cursor: pointer; margin-top: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #2980b9; }
        
        .btn-delete { background-color: #e74c3c; color: white; }
        .btn-delete:hover { background-color: #c0392b; }
        .btn-priority { background-color: #2ecc71; color: white; }
        .btn-priority:hover { background-color: #27ae60; }
        
        .data-table { width: 100%; border-collapse: collapse; margin-top: 1em; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        .data-table th { background-color: #ecf0f1; font-weight: bold; }
        .deleted-row { color: #999; font-style: italic; background-color: #f2f2f2; }
        
        .task-list { list-style: none; padding: 0; }
        .task-item { background: #fefefe; border: 1px solid #eee; padding: 15px; margin-bottom: 10px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between; }
        .task-item.prioritaria { border-left: 5px solid #f39c12; }
        .task-item.completada { background-color: #e8f5e9; opacity: 0.7; }
        .task-actions { display: flex; gap: 10px; }
        .task-actions button { padding: 5px 10px; width: auto; font-size: 0.9em; margin-top: 0; }
        .summary-box { background-color: #ecf0f1; padding: 1em; border-radius: 8px; margin-top: 1em; }
        .summary-box h3 { margin-top: 0; }
        .historical-data select { margin-top: 10px; }

        .loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.8); display: flex; justify-content: center; align-items: center; font-size: 1.5em; z-index: 1000; }
    </style>
</head>
<body>
    <div id="loading" class="loading-overlay">Cargando...</div>
    <div class="container" style="display: none;">
        <h1>Panel de Administración</h1>

        <div class="form-section">
            <h2>Agregar Tarea</h2>
            <div class="form-group">
                <label for="task-description">Descripción de la Tarea:</label>
                <input type="text" id="task-description" required>
            </div>
            <div class="form-group">
                <label for="task-frequency">Frecuencia:</label>
                <select id="task-frequency">
                    <option value="semanales">Semanal</option>
                    <option value="quincenales">Quincenal</option>
                    <option value="mensuales">Mensual</option>
                </select>
            </div>
            <button onclick="addTask()">Agregar Tarea</button>
        </div>

        <hr>

        <h2 class="section-header">Registro de Ingresos y Egresos</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Fecha</th>
                    <th>Ingreso</th>
                    <th>Egreso</th>
                    <th>Horas Trabajadas</th>
                    <th>Acción</th>
                </tr>
            </thead>
            <tbody id="access-log"></tbody>
        </table>

        <div class="summary-box">
            <h3>Resumen de Horas</h3>
            <p>Horas trabajadas esta semana: <span id="admin-weekly-hours">0</span></p>
            <p>Horas trabajadas este mes: <span id="admin-monthly-hours">0</span></p>
        </div>

        <hr>

        <h2 class="section-header">Gestión de Tareas</h2>
        <ul id="admin-tasks" class="task-list"></ul>
        
        <hr>
        
        <div class="historical-data">
            <h2>Historial de Meses Anteriores</h2>
            <select id="month-selector" onchange="loadHistoricalData(this.value)"></select>
            <div id="historical-content"></div>
        </div>
        
        <hr>
        
        <div class="deleted-records">
            <h2>Registros Eliminados</h2>
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Fecha</th>
                        <th>Horas Originales</th>
                        <th>Motivo de Eliminación</th>
                    </tr>
                </thead>
                <tbody id="deleted-log"></tbody>
            </table>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, doc, addDoc, updateDoc, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        
        let db, auth, userId;

        async function initFirebase() {
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                }
                
                userId = auth.currentUser.uid;
                
                document.getElementById('loading').style.display = 'none';
                document.querySelector('.container').style.display = 'block';

                setupRealtimeListeners();
                renderHistoricalSelector();
            } catch (error) {
                console.error("Error al inicializar Firebase:", error);
                document.getElementById('loading').textContent = 'Error al cargar la aplicación.';
            }
        }
        
        async function setupRealtimeListeners() {
            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/ingresos`), (snapshot) => {
                renderAccessLog(snapshot);
            });

            onSnapshot(collection(db, `artifacts/${appId}/users/${userId}/tareas`), (snapshot) => {
                renderTasksStatus(snapshot);
            });

            onSnapshot(collection(db, `artifacts/${appId}/public/data/deleted_records`), (snapshot) => {
                renderDeletedLog(snapshot);
            });
        }

        window.onload = initFirebase;

        async function addTask() {
            const description = document.getElementById('task-description').value;
            const frequency = document.getElementById('task-frequency').value;
            
            if (description.trim() === '') {
                console.log('La descripción de la tarea no puede estar vacía.');
                return;
            }
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/users/${userId}/tareas`), {
                    descripcion: description,
                    frecuencia: frequency,
                    completada: false,
                    prioritaria: false
                });
                document.getElementById('task-description').value = '';
            } catch (error) {
                console.error("Error al agregar la tarea:", error);
            }
        }

        async function deleteTask(docId) {
            if (prompt('¿Estás seguro de que quieres eliminar esta tarea? Escribe "si" para confirmar.') !== 'si') {
                 return;
            }
            const taskRef = doc(db, `artifacts/${appId}/users/${userId}/tareas`, docId);
            try {
                await deleteDoc(taskRef);
            } catch (error) {
                console.error("Error al eliminar la tarea:", error);
            }
        }
        
        async function togglePriority(docId, currentStatus) {
            const taskRef = doc(db, `artifacts/${appId}/users/${userId}/tareas`, docId);
            try {
                await updateDoc(taskRef, {
                    prioritaria: !currentStatus
                });
            } catch (error) {
                console.error("Error al actualizar la prioridad:", error);
            }
        }
        
        async function deleteAccessRecord(docId, recordData) {
            const reason = prompt("Por favor, ingresa el motivo de la eliminación:");
            if (!reason) {
                return;
            }
            
            const ingresoTime = recordData.ingreso ? new Date(recordData.ingreso) : null;
            const egresoTime = recordData.egreso ? new Date(recordData.egreso) : null;
            const duracion = (ingresoTime && egresoTime) ? ((egresoTime - ingresoTime) / 1000 / 60 / 60) : 0;
            
            try {
                await addDoc(collection(db, `artifacts/${appId}/public/data/deleted_records`), {
                    fecha: docId,
                    ingreso: recordData.ingreso,
                    egreso: recordData.egreso,
                    duracion: duracion,
                    motivo: reason,
                    fechaEliminacion: new Date().toISOString()
                });
                
                await deleteDoc(doc(db, `artifacts/${appId}/users/${userId}/ingresos`, docId));
            } catch (error) {
                console.error("Error al eliminar el registro de acceso:", error);
            }
        }

        function renderAccessLog(snapshot) {
            const logBody = document.getElementById('access-log');
            logBody.innerHTML = '';
            
            let totalWeeklyHours = 0;
            let totalMonthlyHours = 0;
            const now = new Date();
            const firstDayOfWeek = new Date(now);
            firstDayOfWeek.setDate(now.getDate() - (now.getDay() === 0 ? 6 : now.getDay() - 1));
            firstDayOfWeek.setHours(0, 0, 0, 0);

            snapshot.forEach(doc => {
                const date = doc.id;
                const entry = doc.data();
                const entryDate = new Date(date.replace(/-/g, '/'));
                
                const tr = document.createElement('tr');
                const ingresoTime = entry.ingreso ? new Date(entry.ingreso).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                const egresoTime = entry.egreso ? new Date(entry.egreso).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                const duracion = entry.egreso ? ((new Date(entry.egreso) - new Date(entry.ingreso)) / 1000 / 60 / 60).toFixed(2) + 'h' : 'N/A';
                
                tr.innerHTML = `
                    <td>${date}</td>
                    <td>${ingresoTime}</td>
                    <td>${egresoTime}</td>
                    <td>${duracion}</td>
                    <td><button class="btn-delete" onclick="deleteAccessRecord('${date}', ${JSON.stringify(entry)})">Eliminar</button></td>
                `;
                logBody.appendChild(tr);

                if (entry.egreso) {
                    const durationInHours = (new Date(entry.egreso) - new Date(entry.ingreso)) / 1000 / 60 / 60;
                    if (entryDate >= firstDayOfWeek && entryDate <= now) {
                        totalWeeklyHours += durationInHours;
                    }
                    if (entryDate.getMonth() === now.getMonth() && entryDate.getFullYear() === now.getFullYear()) {
                        totalMonthlyHours += durationInHours;
                    }
                }
            });
            
            document.getElementById('admin-weekly-hours').textContent = totalWeeklyHours.toFixed(2);
            document.getElementById('admin-monthly-hours').textContent = totalMonthlyHours.toFixed(2);
        }
        
        function renderDeletedLog(snapshot) {
            const deletedLogBody = document.getElementById('deleted-log');
            deletedLogBody.innerHTML = '';

            snapshot.forEach(doc => {
                const record = doc.data();
                const tr = document.createElement('tr');
                tr.classList.add('deleted-row');
                const originalHours = record.duracion ? record.duracion.toFixed(2) + 'h' : 'N/A';
                
                tr.innerHTML = `
                    <td>${record.fecha}</td>
                    <td>${originalHours}</td>
                    <td>${record.motivo}</td>
                `;
                deletedLogBody.appendChild(tr);
            });
        }

        function renderTasksStatus(snapshot) {
            const list = document.getElementById('admin-tasks');
            list.innerHTML = '';
            
            const allTasks = [];
            snapshot.forEach(doc => {
                allTasks.push({ ...doc.data(), docId: doc.id });
            });
            
            allTasks.forEach(task => {
                const li = document.createElement('li');
                li.classList.add('task-item');
                if (task.prioritaria) li.classList.add('prioritaria');
                if (task.completada) li.classList.add('completada');
                
                const frequencyText = {
                    semanales: 'Semanal',
                    quincenales: 'Quincenal',
                    mensuales: 'Mensual'
                };
                
                li.innerHTML = `
                    <span>[${frequencyText[task.frecuencia]}] ${task.descripcion}</span>
                    <div class="task-actions">
                        <span style="color: ${task.completada ? 'green' : 'red'};">${task.completada ? 'Completada' : 'Pendiente'}</span>
                        <button class="btn-priority" onclick="togglePriority('${task.docId}', ${task.prioritaria})">${task.prioritaria ? 'Quitar Prioridad' : 'Marcar Prioridad'}</button>
                        <button class="btn-delete" onclick="deleteTask('${task.docId}')">Eliminar</button>
                    </div>
                `;
                list.appendChild(li);
            });
        }
        
        function renderHistoricalSelector() {
            const selector = document.getElementById('month-selector');
            selector.innerHTML = '<option value="">Seleccionar Mes</option>';
            
            const months = [
                'Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'
            ];
            
            const currentYear = new Date().getFullYear();
            
            for (let i = 0; i < 12; i++) {
                const option = document.createElement('option');
                option.value = `${currentYear}-${i}`;
                option.textContent = `${months[i]} ${currentYear}`;
                selector.appendChild(option);
            }
        }
        
        async function loadHistoricalData(key) {
            const contentDiv = document.getElementById('historical-content');
            contentDiv.innerHTML = '<p>Cargando datos históricos...</p>';
            
            if (!key) {
                contentDiv.innerHTML = '';
                return;
            }
            
            const [year, month] = key.split('-');
            const startDate = new Date(year, month, 1);
            const endDate = new Date(year, parseInt(month) + 1, 0);
            
            try {
                const q = query(collection(db, `artifacts/${appId}/users/${userId}/ingresos`));
                const snapshot = await getDocs(q);
                
                const monthData = [];
                snapshot.forEach(doc => {
                    const docDate = new Date(doc.id.replace(/-/g, '/'));
                    if (docDate >= startDate && docDate <= endDate) {
                        monthData.push({ id: doc.id, ...doc.data() });
                    }
                });

                if (monthData.length === 0) {
                    contentDiv.innerHTML = '<p>No hay datos para este mes.</p>';
                    return;
                }
                
                const accessLogTable = document.createElement('table');
                accessLogTable.classList.add('data-table');
                accessLogTable.innerHTML = `
                    <thead><tr><th>Fecha</th><th>Ingreso</th><th>Egreso</th><th>Horas Trabajadas</th></tr></thead>
                    <tbody></tbody>
                `;
                const logBody = accessLogTable.querySelector('tbody');
                
                monthData.forEach(entry => {
                    const tr = document.createElement('tr');
                    const ingresoTime = entry.ingreso ? new Date(entry.ingreso).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                    const egresoTime = entry.egreso ? new Date(entry.egreso).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' }) : 'N/A';
                    const duracion = entry.egreso ? ((new Date(entry.egreso) - new Date(entry.ingreso)) / 1000 / 60 / 60).toFixed(2) + 'h' : 'N/A';
                    tr.innerHTML = `<td>${entry.id}</td><td>${ingresoTime}</td><td>${egresoTime}</td><td>${duracion}</td>`;
                    logBody.appendChild(tr);
                });
                
                contentDiv.innerHTML = '';
                contentDiv.appendChild(accessLogTable);
                
            } catch (error) {
                console.error("Error al cargar datos históricos:", error);
                contentDiv.innerHTML = '<p>Error al cargar los datos. Por favor, revisa la consola para más detalles.</p>';
            }
        }
    </script>
</body>
</html>