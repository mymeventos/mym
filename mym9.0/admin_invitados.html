<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administrador de Invitados - Salón M&M</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-5xl">
        <header class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-bold text-gray-900">Administrador de Invitados</h1>
            <p id="event-name-header" class="text-lg text-indigo-600 font-semibold mt-2">&nbsp;</p>
        </header>

        <!-- Carga Masiva de Invitados -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-2">Carga Masiva de Invitados</h2>
            <p class="text-sm text-gray-600 mb-4">
                Copia las columnas (Apellido, Nombre, Mesa) desde Excel o Sheets y pégalas aquí.
            </p>
            <div>
                <textarea id="bulk-guest-input" rows="10" class="w-full p-3 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Copia y pega las filas de tu planilla aquí..."></textarea>
                <button id="preview-bulk-btn" class="mt-4 w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-md shadow-sm transition-transform transform hover:scale-105">
                    Previsualizar y Cargar Lista
                </button>
            </div>
        </div>
        
        <!-- Formulario para agregar un solo invitado -->
        <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-semibold mb-4">Añadir Un Invitado</h2>
            <form id="add-guest-form" class="grid sm:grid-cols-3 gap-4 items-end">
                <div class="sm:col-span-2">
                    <label for="guest-name" class="block text-sm font-medium text-gray-700">Nombre del Invitado</label>
                    <input type="text" id="guest-name" placeholder="Ej: Juan Pérez" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <div>
                    <label for="guest-table" class="block text-sm font-medium text-gray-700">Mesa</label>
                    <input type="text" id="guest-table" placeholder="Ej: 5" required class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm">
                </div>
                <button type="submit" class="sm:col-start-3 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-md shadow-sm">
                    Agregar Invitado
                </button>
            </form>
        </div>

        <!-- Lista de Invitados -->
        <div class="bg-white p-6 rounded-xl shadow-lg">
            <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                <h2 class="text-2xl font-semibold">Lista de Invitados</h2>
                <div class="flex items-center gap-4">
                    <p class="text-lg font-bold text-indigo-600"><span id="guest-count">0</span> Invitados</p>
                    <button id="clear-all-btn" class="bg-red-600 hover:bg-red-800 text-white font-bold py-2 px-3 rounded-md text-sm shadow-sm">
                        Limpiar Lista Completa
                    </button>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mesa</th>
                            <th scope="col" class="relative px-6 py-3"><span class="sr-only">Eliminar</span></th>
                        </tr>
                    </thead>
                    <tbody id="guest-list" class="bg-white divide-y divide-gray-200">
                        <tr id="loading-state"><td colspan="3" class="text-center py-10 text-gray-500">Cargando...</td></tr>
                    </tbody>
                </table>
                 <div id="empty-state" class="hidden text-center py-10 px-4">
                    <h3 class="mt-2 text-lg font-medium text-gray-900">No hay invitados</h3>
                    <p class="mt-1 text-sm text-gray-500">Añade invitados usando los formularios de arriba.</p>
                </div>
            </div>
        </div>
         <div class="mt-8 text-center">
            <a href="selector_de_eventos.html" class="text-indigo-600 hover:text-indigo-800 font-medium">← Volver al Panel de Eventos</a>
        </div>
    </div>

    <!-- Modals -->
    <div id="delete-modal" class="hidden fixed inset-0 z-50"></div>
    <div id="clear-all-modal" class="hidden fixed inset-0 z-50"></div>
    <div id="bulk-preview-modal" class="hidden fixed inset-0 z-50"></div>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, deleteDoc, query, writeBatch, getDocs, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyDtr9JCvgHriGZNfk1Exw-wl6zXGRrzawE",
            authDomain: "salon-de-eventos-mm.firebaseapp.com",
            projectId: "salon-de-eventos-mm",
            storageBucket: "salon-de-eventos-mm.firebasestorage.app",
            messagingSenderId: "1026723246426",
            appId: "1:1026723246426:web:518abd5aecd6e279bc0363",
            measurementId: "G-6QHQ0GDS25"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let guestsCollection;
        let eventId;
        let guestToDeleteId = null;
        let parsedGuests = [];

        const addGuestForm = document.getElementById('add-guest-form');
        const guestNameInput = document.getElementById('guest-name');
        const guestTableInput = document.getElementById('guest-table');
        const guestListEl = document.getElementById('guest-list');
        const guestCountEl = document.getElementById('guest-count');
        const loadingState = document.getElementById('loading-state');
        const emptyState = document.getElementById('empty-state');
        const eventNameHeader = document.getElementById('event-name-header');
        
        const bulkGuestInput = document.getElementById('bulk-guest-input');
        const previewBulkBtn = document.getElementById('preview-bulk-btn');

        const deleteModalEl = document.getElementById('delete-modal');
        const clearAllModalEl = document.getElementById('clear-all-modal');
        const bulkPreviewModalEl = document.getElementById('bulk-preview-modal');

        const clearAllBtn = document.getElementById('clear-all-btn');

        // --- INICIALIZACIÓN ---
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            eventId = urlParams.get('eventId');

            if (!eventId) {
                document.body.innerHTML = '<div class="text-center p-8 text-red-500">Error: No se ha especificado un ID de evento. Por favor, accede desde el <a href="selector_de_eventos.html" class="underline">Panel de Eventos</a>.</div>';
                return;
            }

            onAuthStateChanged(auth, user => {
                if (user) {
                    setupPageForEvent();
                } else {
                    signInAnonymously(auth).catch(error => console.error("Auth error:", error));
                }
            });
        });

        async function setupPageForEvent() {
            // Obtener y mostrar el nombre del evento
            const eventRef = doc(db, 'events', eventId);
            const eventSnap = await getDoc(eventRef);
            if (eventSnap.exists()) {
                eventNameHeader.textContent = `Editando invitados para: ${eventSnap.data().name}`;
            } else {
                eventNameHeader.textContent = "Evento no encontrado";
            }

            // Configurar la colección de invitados para este evento
            guestsCollection = collection(db, 'events', eventId, 'guests');
            listenForGuests();
        }

        function listenForGuests() {
            onSnapshot(query(guestsCollection), (snapshot) => {
                loadingState.style.display = 'none';
                const guests = [];
                snapshot.forEach(doc => guests.push({ id: doc.id, ...doc.data() }));
                guests.sort((a, b) => a.nombre.localeCompare(b.nombre));
                
                guestCountEl.textContent = guests.length;
                emptyState.style.display = guests.length === 0 ? 'block' : 'none';
                
                renderGuests(guests);
            }, (error) => {
                console.error("Error fetching guests: ", error);
                guestListEl.innerHTML = `<tr><td colspan="3" class="text-center py-10 text-red-500">Error al cargar la lista.</td></tr>`;
            });
        }

        function renderGuests(guests) {
            guestListEl.innerHTML = '';
            guests.forEach(guest => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-gray-50";
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${guest.nombre}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${guest.mesa}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button data-id="${guest.id}" data-name="${guest.nombre}" class="delete-btn text-red-600 hover:text-red-900">Eliminar</button>
                    </td>
                `;
                guestListEl.appendChild(tr);
            });
        }

        addGuestForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const guestName = guestNameInput.value.trim();
            const guestTable = guestTableInput.value.trim();
            if (guestName && guestTable && guestsCollection) {
                try {
                    await addDoc(guestsCollection, { nombre: guestName, mesa: guestTable, presente: false });
                    addGuestForm.reset();
                    guestNameInput.focus();
                } catch (error) {
                    console.error("Error adding guest: ", error);
                }
            }
        });

        previewBulkBtn.addEventListener('click', () => {
            const text = bulkGuestInput.value.trim();
            if (!text) return;
            const lines = text.split('\n');
            parsedGuests = [];
            const errors = [];
            lines.forEach((line, index) => {
                if (line.trim() === '') return;
                let parts = line.split('\t').map(p => p.trim());
                if (parts.length >= 3 && parts[0] && parts[1] && parts[2]) {
                    const fullName = `${parts[0]} ${parts[1]}`;
                    const table = parts[2];
                    parsedGuests.push({ nombre: fullName, mesa: table, presente: false });
                } else {
                    errors.push({ line: index + 1, content: line });
                }
            });
            openBulkPreviewModal(parsedGuests, errors);
        });

        async function saveBulkGuests() {
            if (parsedGuests.length === 0) return;
            const batch = writeBatch(db);
            parsedGuests.forEach(guest => {
                const newGuestRef = doc(guestsCollection);
                batch.set(newGuestRef, guest);
            });
            try {
                await batch.commit();
                bulkGuestInput.value = '';
                closeModal(bulkPreviewModalEl);
            } catch (error) {
                console.error("Error bulk adding guests: ", error);
                alert("Error al guardar los invitados. Revisa la consola y las reglas de seguridad de Firestore.");
            }
        }

        guestListEl.addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-btn')) {
                guestToDeleteId = e.target.dataset.id;
                openDeleteModal(e.target.dataset.name);
            }
        });
        
        async function deleteGuest() {
            if (guestToDeleteId && guestsCollection) {
                try {
                    await deleteDoc(doc(guestsCollection, guestToDeleteId));
                    closeModal(deleteModalEl);
                } catch (error) {
                    console.error("Error deleting guest: ", error);
                }
            }
        }

        clearAllBtn.addEventListener('click', openClearAllModal);

        async function clearAllGuests() {
            try {
                const snapshot = await getDocs(query(guestsCollection));
                if (snapshot.empty) {
                    closeModal(clearAllModalEl);
                    return;
                }
                const batch = writeBatch(db);
                snapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                closeModal(clearAllModalEl);
            } catch (error) {
                console.error("Error clearing all guests: ", error);
            }
        }

        function openDeleteModal(name) {
            deleteModalEl.innerHTML = createModalHTML({
                title: 'Eliminar invitado',
                body: `¿Estás seguro de que quieres eliminar a <strong>${name}</strong>? Esta acción no se puede deshacer.`,
                confirmText: 'Eliminar',
                confirmClass: 'bg-red-600 hover:bg-red-700',
                onConfirm: deleteGuest,
                modalId: 'delete-modal'
            });
            deleteModalEl.classList.remove('hidden');
        }

        function openClearAllModal() {
            clearAllModalEl.innerHTML = createModalHTML({
                title: '¡Atención! Limpiar Lista Completa',
                body: `¿Estás <strong>COMPLETAMENTE SEGURO</strong>? Se borrarán <strong>TODOS</strong> los invitados de este evento de forma permanente.`,
                confirmText: 'Sí, Borrar Todo',
                confirmClass: 'bg-red-600 hover:bg-red-700',
                onConfirm: clearAllGuests,
                modalId: 'clear-all-modal'
            });
            clearAllModalEl.classList.remove('hidden');
        }

        function openBulkPreviewModal(guests, errors) {
            const body = `
                <p class="text-sm text-gray-700 mb-2">Se agregarán <strong>${guests.length}</strong> invitados nuevos a este evento.</p>
                <div class="max-h-60 overflow-y-auto border rounded-md bg-gray-50 p-2">
                    ${guests.map(g => `<div class="text-sm text-green-700"><b>Nombre:</b> ${g.nombre}, <b>Mesa:</b> ${g.mesa}</div>`).join('')}
                    ${errors.map(e => `<div class="text-sm text-red-700" title="Línea ${e.line}"><strong>Error en línea:</strong> ${e.content}</div>`).join('')}
                </div>
                ${errors.length > 0 ? `<p class="text-sm text-red-600 mt-2">Se encontraron <strong>${errors.length}</strong> líneas con formato incorrecto. Por favor, corrígelas en tu planilla y vuelve a pegar la lista completa.</p>` : ''}
            `;
            bulkPreviewModalEl.innerHTML = createModalHTML({
                title: 'Previsualización de Carga Masiva',
                body: body,
                confirmText: 'Confirmar y Guardar',
                confirmClass: 'bg-green-600 hover:bg-green-700',
                onConfirm: saveBulkGuests,
                modalId: 'bulk-preview-modal',
                disableConfirm: errors.length > 0
            });
            bulkPreviewModalEl.classList.remove('hidden');
        }

        function closeModal(modal) {
            modal.classList.add('hidden');
            modal.innerHTML = '';
        }

        function createModalHTML({ title, body, confirmText, confirmClass, onConfirm, modalId, disableConfirm = false }) {
            const modal = document.getElementById(modalId);
            const confirmBtnId = `confirm-${modalId}`;
            const cancelBtnId = `cancel-${modalId}`;

            setTimeout(() => {
                document.getElementById(confirmBtnId)?.addEventListener('click', onConfirm);
                document.getElementById(cancelBtnId)?.addEventListener('click', () => closeModal(modal));
            }, 0);

            return `
                <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
                    <div class="fixed inset-0 bg-gray-500 bg-opacity-75"></div>
                    <div class="bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                        <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                            <h3 class="text-lg leading-6 font-medium text-gray-900">${title}</h3>
                            <div class="mt-2">${body}</div>
                        </div>
                        <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                            <button id="${confirmBtnId}" type="button" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 text-base font-medium text-white ${confirmClass} ${disableConfirm ? 'opacity-50 cursor-not-allowed' : ''}" ${disableConfirm ? 'disabled' : ''}>${confirmText}</button>
                            <button id="${cancelBtnId}" type="button" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 sm:mt-0 sm:w-auto">Cancelar</button>
                        </div>
                    </div>
                </div>
            `;
        }
    </script>
</body>
</html>
